### 0. 회원가입
POST http://localhost:8080/api/v1/auth/signup
Content-Type: application/json

{
  "email": "test@example.com",
  "password": "Test1234!@#",
  "nickName": "Beemo"
}

### 0-1. 로그인(HOST) - accessToken 발급
POST http://localhost:8080/api/v1/auth/login
Content-Type: application/json

{
  "email": "test@example.com",
  "password": "Test1234!@#"
}

> {%
  client.global.set("accessToken", response.body.data.accessToken);
%}


### 1. UPDATE 테스트 준비: 이미지 선 업로드 3장 (A,B,C)
POST http://localhost:8080/api/v2/groups/images/upload
Content-Type: multipart/form-data; boundary=boundary
Authorization: Bearer {{accessToken}}

--boundary
Content-Disposition: form-data; name="images"; filename="img1.png"
Content-Type: image/png

< ../../image/resources/img1.png
--boundary
Content-Disposition: form-data; name="images"; filename="img2.jpg"
Content-Type: image/jpeg

< ../../image/resources/img2.jpg
--boundary
Content-Disposition: form-data; name="images"; filename="img4.jpg"
Content-Type: image/jpeg

< ../../image/resources/img4.jpg
--boundary--

> {%
  const images = response.body.data.images;
  client.global.set("imgA_key", images[0].imageKey);
  client.global.set("imgB_key", images[1].imageKey);
  client.global.set("imgC_key", images[2].imageKey);
%}


### 2. 모임 V2 생성 (A,B,C)
POST http://localhost:8080/api/v2/groups/create
Content-Type: application/json
Authorization: Bearer {{accessToken}}

{
  "title": "UPDATE 이미지 테스트 모임",
  "location": "서울 강남구",
  "joinPolicy": "FREE",
  "locationDetail": "강남역 2번 출구 근처 카페",
  "startTime": "2026-12-10T19:00:00",
  "endTime": "2026-12-10T21:00:00",
  "tags": ["자바","백엔드","스터디"],
  "description": "A,B,C 생성 후 update로 A 삭제 + C 대표 + D 추가",
  "maxParticipants": 12,
  "images": [
    { "sortOrder": 0, "imageKey": "{{imgA_key}}" },
    { "sortOrder": 1, "imageKey": "{{imgB_key}}" },
    { "sortOrder": 2, "imageKey": "{{imgC_key}}" }
  ]
}

> {%
  client.global.set("groupId_updateTest", response.body.data.id);
%}


### 3. D 이미지 선 업로드 (추가할 신규 이미지)
POST http://localhost:8080/api/v2/groups/images/upload
Content-Type: multipart/form-data; boundary=boundary
Authorization: Bearer {{accessToken}}

--boundary
Content-Disposition: form-data; name="images"; filename="imgD.png"
Content-Type: image/png

< ../../image/resources/img1.png
--boundary--

> {%
  const images = response.body.data.images;
  client.global.set("imgD_key", images[0].imageKey);
%}


### 4. PATCH - A 삭제 + C 대표 + D 추가 (최종 순서: C,B,D)
PATCH http://localhost:8080/api/v2/groups
    /{{groupId_updateTest}}
Content-Type: application/json
Authorization: Bearer {{accessToken}}

{
  "images": [
    { "sortOrder": 0, "imageKey": "{{imgC_key}}" },
    { "sortOrder": 1, "imageKey": "{{imgB_key}}" },
    { "sortOrder": 2, "imageKey": "{{imgD_key}}" }
  ]
}

> {%
  const body = response.body;
  const imgs = (body.data && body.data.images) ? body.data.images : body.images;

  client.test("images 배열 존재", () => client.assert(!!imgs));

  client.log("imgs keys = " + JSON.stringify(imgs.map(i => i.imageKey)));
  client.log("expected C = " + client.global.get("imgC_key"));
  client.log("expected B = " + client.global.get("imgB_key"));
  client.log("expected D = " + client.global.get("imgD_key"));

  client.test("images 3개인지", () => client.assert(imgs.length === 3));
  client.test("정렬 0,1,2인지", () => client.assert(
      imgs[0].sortOrder === 0 && imgs[1].sortOrder === 1 && imgs[2].sortOrder === 2
  ));

  client.test("최종 순서가 C,B,D인지", () => client.assert(
      imgs[0].imageKey === client.global.get("imgC_key") &&
      imgs[1].imageKey === client.global.get("imgB_key") &&
      imgs[2].imageKey === client.global.get("imgD_key")
  ));

  client.test("0번이 C인지", () => client.assert(imgs[0].imageKey === client.global.get("imgC_key")));
  client.test("1번이 B인지", () => client.assert(imgs[1].imageKey === client.global.get("imgB_key")));
  client.test("2번이 D인지", () => client.assert(imgs[2].imageKey === client.global.get("imgD_key")));
%}


### 5. PATCH - 태그 중복 예외 기대(TAG_DUPLICATED)
PATCH http://localhost:8080/api/v2/groups/{{groupId_updateTest}}
Content-Type: application/json
Authorization: Bearer {{accessToken}}

{
  "tags": ["자바", "자바", "스터디"]
}


### 6. PATCH - 태그 10개 초과 예외 기대(TAG_EXCEED_MAX)
PATCH http://localhost:8080/api/v2/groups/{{groupId_updateTest}}
Content-Type: application/json
Authorization: Bearer {{accessToken}}

{
  "tags": ["t1","t2","t3","t4","t5","t6","t7","t8","t9","t10","t11"]
}


### 7. PATCH - 이미지 전체 삭제 => 기본 이미지(variants 2개) 내려와야 함
PATCH http://localhost:8080/api/v2/groups/{{groupId_updateTest}}
Content-Type: application/json
Authorization: Bearer {{accessToken}}

{
  "images": []
}

> {%
  const body = response.body;
  const imgs = (body.data && body.data.images) ? body.data.images : body.images;

  client.test("images 배열 존재", () => client.assert(!!imgs));
  client.test("기본 이미지 1개 내려옴", () => client.assert(imgs.length === 1));
  client.test("default imageKey=DEFAULT", () => client.assert(imgs[0].imageKey === "DEFAULT"));
  client.test("variants 2개", () => client.assert(imgs[0].variants.length === 2));

  const urls = imgs[0].variants.map(v => v.imageUrl);
  client.test("기본 440 포함", () => client.assert(urls.includes("https://we-go-bucket.s3.ap-northeast-2.amazonaws.com/default/group_logo_440x240.webp")));
  client.test("기본 100 포함", () => client.assert(urls.includes("https://we-go-bucket.s3.ap-northeast-2.amazonaws.com/default/group_logo_100x100.webp")));
%}


### 이미지 2장 선 업로드 (A, B)
POST http://localhost:8080/api/v2/groups/images/upload
Content-Type: multipart/form-data; boundary=boundary
Authorization: Bearer {{accessToken}}

--boundary
Content-Disposition: form-data; name="images"; filename="a.png"
Content-Type: image/png

< ../../image/resources/img1.png
--boundary
Content-Disposition: form-data; name="images"; filename="b.jpg"
Content-Type: image/jpeg

< ../../image/resources/img2.jpg
--boundary--

> {%
  const images = response.body.data.images;
  client.global.set("imgA_key", images[0].imageKey);
  client.global.set("imgB_key", images[1].imageKey);
%}


### 모임 생성 (A 대표, B 2번)
POST http://localhost:8080/api/v2/groups/create
Content-Type: application/json
Authorization: Bearer {{accessToken}}

{
  "title": "A,B 이미지 모임",
  "location": "서울 강남구",
  "joinPolicy": "FREE",
  "locationDetail": "어딘가",
  "startTime": "2026-12-10T19:00:00",
  "endTime": "2026-12-10T21:00:00",
  "tags": ["자바","스터디"],
  "description": "A 대표, B 보조",
  "maxParticipants": 12,
  "images": [
    { "sortOrder": 0, "imageKey": "{{imgA_key}}" },
    { "sortOrder": 1, "imageKey": "{{imgB_key}}" }
  ]
}

> {%
  client.global.set("groupId_ab", response.body.data.id);
%}


### 신규 이미지 1장 선 업로드 (C)
POST http://localhost:8080/api/v2/groups/images/upload
Content-Type: multipart/form-data; boundary=boundary
Authorization: Bearer {{accessToken}}

--boundary
Content-Disposition: form-data; name="images"; filename="c.png"
Content-Type: image/png

< ../../image/resources/img4.jpg
--boundary--

> {%
  const images = response.body.data.images;
  client.global.set("imgC_key", images[0].imageKey);
%}


### PATCH (A 삭제 + B 대표 + C 추가 => 최종 [B, C])
PATCH http://localhost:8080/api/v2/groups/{{groupId_ab}}
Content-Type: application/json
Authorization: Bearer {{accessToken}}

{
  "images": [
    { "sortOrder": 0, "imageKey": "{{imgB_key}}" },
    { "sortOrder": 1, "imageKey": "{{imgC_key}}" }
  ]
}

> {%
  const body = response.body;
  const imgs = (body.data && body.data.images) ? body.data.images : body.images;

  client.test("2장인지", () => client.assert(imgs.length === 2));
  client.test("0번이 B(대표)", () => client.assert(imgs[0].imageKey === client.global.get("imgB_key")));
  client.test("1번이 C", () => client.assert(imgs[1].imageKey === client.global.get("imgC_key")));
  client.test("sortOrder 0,1", () => client.assert(imgs[0].sortOrder === 0 && imgs[1].sortOrder === 1));
%}


### [예제] 모임 V2 생성 - 필드 다양하게 포함 (이미지 2장 선업로드 → create)
### 1) 이미지 선 업로드 (대표/보조로 쓸 2장)
POST http://localhost:8080/api/v2/groups/images/upload
Content-Type: multipart/form-data; boundary=boundary
Authorization: Bearer {{accessToken}}

--boundary
Content-Disposition: form-data; name="images"; filename="cover.webp"
Content-Type: image/webp

< ../../image/resources/img1.png
--boundary
Content-Disposition: form-data; name="images"; filename="sub.jpg"
Content-Type: image/jpeg

< ../../image/resources/img2.jpg
--boundary--

> {%
  const images = response.body.data.images;
  client.global.set("ex_cover_key", images[0].imageKey);
  client.global.set("ex_sub_key", images[1].imageKey);
%}


### 2) 모임 생성 (필드 다양화 + images는 (sortOrder, imageKey) 배열)
POST http://localhost:8080/api/v2/groups/create
Content-Type: application/json
Authorization: Bearer {{accessToken}}

{
  "title": "주말 러닝 + 백엔드 토크 모임 (예제)",
  "joinPolicy": "FREE",
  "location": "서울 강남구",
  "locationDetail": "역삼역 2번 출구 앞 (집결 후 이동)",
  "startTime": "2026-12-20T09:30:00",
  "endTime": "2026-12-20T12:00:00",
  "tags": ["러닝", "주말", "백엔드", "네트워킹"],
  "description": "가벼운 5km 러닝 후 카페로 이동해서 백엔드/커리어 토크합니다. 초보도 환영!",
  "maxParticipants": 12,
  "images": [
    { "sortOrder": 0, "imageKey": "{{ex_cover_key}}" },
    { "sortOrder": 1, "imageKey": "{{ex_sub_key}}" }
  ]
}

> {%
  client.global.set("groupId_example", response.body.data.id);
%}


### [수정 예시] PATCH - 모임 필드 다양하게 수정 + 이미지 교체(재정렬)
### 1) 수정용 신규 이미지 2장 선 업로드
POST http://localhost:8080/api/v2/groups/images/upload
Content-Type: multipart/form-data; boundary=boundary
Authorization: Bearer {{accessToken}}

--boundary
Content-Disposition: form-data; name="images"; filename="new1.jpeg"
Content-Type: image/jpeg

< ../../image/resources/img3.jpeg
--boundary
Content-Disposition: form-data; name="images"; filename="new4.jpg"
Content-Type: image/jpeg

< ../../image/resources/img4.jpg
--boundary--

> {%
  const images = response.body.data.images;
  client.global.set("patch_img1_key", images[0].imageKey);
  client.global.set("patch_img2_key", images[1].imageKey);
%}


### 2) PATCH - 필드 다양하게 수정 + images는 반드시 채워서 전달(빈 배열은 전체 삭제)
PATCH http://localhost:8080/api/v2/groups/{{groupId_example}}
Content-Type: application/json
Authorization: Bearer {{accessToken}}

{
  "title": "모임 제목 수정",
  "description": "설명 수정 - 일정/장소/참여 조건을 업데이트했습니다.",
  "location": "서울 강남구",
  "locationDetail": "역삼역 2번 출구",
  "startTime": "2025-12-30T19:00:00",
  "endTime": "2025-12-30T21:00:00",
  "maxParticipants": 10,
  "status": "CLOSED",
  "tags": ["러닝", "주말"],
  "images": [
    { "sortOrder": 0, "imageKey": "{{patch_img1_key}}" },
    { "sortOrder": 1, "imageKey": "{{patch_img2_key}}" }
  ]
}

> {%
  const body = response.body;
  const imgs = (body.data && body.data.images) ? body.data.images : body.images;

  client.test("images 배열 존재", () => client.assert(!!imgs));
  client.test("images 2개인지", () => client.assert(imgs.length === 2));

  client.test("0번이 patch_img1_key(대표)인지", () => client.assert(
      imgs[0].imageKey === client.global.get("patch_img1_key")
  ));
  client.test("1번이 patch_img2_key인지", () => client.assert(
      imgs[1].imageKey === client.global.get("patch_img2_key")
  ));

  client.test("sortOrder 0,1인지", () => client.assert(
      imgs[0].sortOrder === 0 && imgs[1].sortOrder === 1
  ));
%}
